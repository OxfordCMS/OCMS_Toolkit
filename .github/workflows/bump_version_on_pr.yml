name: Bump Version on PR

on: 
  pull_request:
    types: [opened, labeled, unlabeled]

permissions:
  contents: write
  pull-requests: read

jobs:
  bump_version:
    runs-on: ubuntu-latest
    concurrency: 
      group: version-bump-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get bump level from PR labels
        id: bump_level
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name.toLowerCase());
            let level = 'patch';
            if (labels.includes('major')) level = 'major';
            else if (labels.includes('minor')) level = 'minor';
            core.setOutput('level', level);
            core.info(`Detected bump level: ${level} (labels: ${labels.join(', ')})`);

      - name: Calculate next version
        id: next_version
        run: |
          latest=$(git tag -l 'v*.*.*' --sort=-version:refname | head -n 1 || echo "v0.0.0")
          version=${latest#v}
          IFS='.' read -r major minor patch <<<"$version"
          major=${major:-0}
          minor=${minor:-0}
          patch=${patch:-0}

          level="${{ steps.bump_level.outputs.level }}"
          case $level in
            major) major=$((major + 1)); minor=0; patch=0 ;;
            minor) minor=$((minor + 1)); patch=0 ;;
            *) patch=$((patch + 1)) ;;
          esac

          next_version="$major.$minor.$patch"
          echo "version=$next_version" >> "$GITHUB_OUTPUT"
          echo "New version: $next_version"

      - name: Update setup.py and commit to PR branch
        run: |
          new_version="${{ steps.next_version.outputs.version }}"
          current_version=$(sed -n 's/.*version="\([^"]*\)".*/\1/p' setup.py)
          
          if [ "$current_version" = "$new_version" ]; then
            echo "Version already at $new_version, skipping commit"
            exit 0
          fi
          
          sed -i "s/version=\"[^\"]*\"/version=\"$new_version\"/" setup.py
          git add setup.py
          git commit -m "chore: bump version to $new_version [skip ci]"
          git push origin HEAD:${{ github.head_ref }}
