name: Bump Version on PR

on: 
  pull_request:
    branches: [main]
    types: [opened, reopened, labeled]

permissions:
  contents: write
  pull-requests: read

jobs:
  bump_version:
    runs-on: ubuntu-latest
    # Prevents concurrent runs for the same PR and cancels outdated ones
    concurrency: 
      group: version-bump-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    steps:
      # Checkout the PR branch to make changes before merge
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history and tags for version calculation
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      # Configure git author for commits
      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # Extract version bump level from PR labels (major, minor, or patch)
      - name: Get bump level from PR labels
        id: bump_level
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name.toLowerCase());
            let level = 'patch';  // Default to patch if no label found
            if (labels.includes('major')) level = 'major';
            else if (labels.includes('minor')) level = 'minor';
            core.setOutput('level', level);
            core.info(`Detected bump level: ${level} (labels: ${labels.join(', ')})`);

      # Get latest tag and calculate the next version number
      - name: Calculate next version
        id: next_version
        run: |
          # Fetch latest version tag (v*.*.* format), sorted by semantic version
          latest=$(git tag -l 'v*.*.*' --sort=-version:refname | head -n 1 || echo "v0.0.0")
          version=${latest#v}
          IFS='.' read -r major minor patch <<<"$version"
          major=${major:-0}
          minor=${minor:-0}
          patch=${patch:-0}

          # Store base version for resetting setup.py
          echo "base_version=$version" >> "$GITHUB_OUTPUT"
          echo "Base version from tag: $version"

          # Increment version based on bump level
          level="${{ steps.bump_level.outputs.level }}"
          case $level in
            major) major=$((major + 1)); minor=0; patch=0 ;;
            minor) minor=$((minor + 1)); patch=0 ;;
            *) patch=$((patch + 1)) ;;
          esac

          next_version="$major.$minor.$patch"
          echo "version=$next_version" >> "$GITHUB_OUTPUT"
          echo "New version: $next_version"

      # Update setup.py with calculated version and push to PR branch
      # Always resets to base version first, then applies the bump
      - name: Update setup.py and commit to PR branch
        run: |
          base_version="${{ steps.next_version.outputs.base_version }}"
          new_version="${{ steps.next_version.outputs.version }}"
          
          # First reset setup.py to base version (from latest tag)
          sed -i "s/version=\"[^\"]*\"/version=\"$base_version\"/" setup.py
          echo "Reset setup.py to base version: $base_version"
          
          # Then update to the new calculated version
          sed -i "s/version=\"[^\"]*\"/version=\"$new_version\"/" setup.py
          echo "Updated setup.py to new version: $new_version"
          
          git add setup.py
          # [skip ci] prevents this commit from triggering workflows again
          git commit -m "chore: bump version to $new_version [skip ci]"
          git push origin HEAD:${{ github.head_ref }}
