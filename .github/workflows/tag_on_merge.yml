name: Tag on Merge

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  create_tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create version tag from setup.py
        run: |
          version=$(sed -n 's/.*version="\([^"]*\)".*/\1/p' setup.py)
          if [ -z "$version" ]; then
            echo "Could not extract version from setup.py" >&2
            exit 1
          fi
          
          tag="v$version"
          git fetch --tags
          
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "Tag $tag already exists locally, skipping tag creation"
            exit 0
          fi
          if git ls-remote --tags origin "$tag" | grep -q "$tag"; then
            echo "Tag $tag already exists on remote, skipping tag creation"
            exit 0
          fi
          
          git tag -a "$tag" -m "Release $tag"
          git push origin "$tag"
          echo "âœ… Tagged commit with $tag"
